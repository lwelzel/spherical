spherical - VLT/SPHERE Instrument Calibration Pipeline and Database
===================================================================

|Pythonv| |ASCL| |DOI| |License|

.. |Pythonv| image:: https://img.shields.io/badge/Python-3.10%2C%203.11-brightgreen.svg
            :target: https://github.com/m-samland/spherical

This repository provides a comprehensive and versatile tool for exploring all VLT/SPHERE observation sequences available in the ESO archive for the IRDIS and IFS instruments, useful for high-contrast imaging.

For SPHERE-IFS, it offers a fully automated workflow from data discovery, download, reduction, to planet detection:

1. Identify the observations you are interested in (e.g., all observations of Beta Pic; all observations of stars within 20 pc, with seeing below 1.5 arcsec and J mag < 8).
2. Download the data for the observations automatically.
3. Extract the IFS spectral cubes with the CHARIS pipeline adaptation (Samland et al. 2022), significantly improving on the ESO pipeline (no esorex required).
4. Perform astrometric and photometric calibration of the extracted data cubes using `A. Vigan's additional tools <https://github.com/avigan/SPHERE>`_.
5. Post-process the data to search for off-axis sources (disk or planet emission) using the TRAP algorithm (Samland et al. 2021).
6. Automatically detect and extract contrast spectra for point sources.
7. Perform absolute flux calibration of the star to convert contrast to flux for detected signals.

The table of all SPHERE observations includes summary information for each observation, such as observing mode, total integration time on target, observing conditions, stellar properties, and more. The database is automatically generated by matching pointing information in the headers of all data taken with SPHERE from the archive to the Gaia catalog and grouping all files belonging to a specific target observation sequence on a given date. Thus, the catalog should be nearly complete and robust against human errors, such as misspelled target names in the OB creation process.
It should be noted that each observation is associated with the closest star in the Gaia catalog of sufficient brightness to be an AO target star. Therefore, observations that did not target specific stars or target solar system objects may be mislabeled.

This package is intended for high-contrast observations that typically have three types of frames: flux frame, coronagraphic frame, and center frame. Center frames are coronagraphic frames with satellite (aka waffle) spots, allowing for detecting the position of the star behind the coronagraph by inducing a modulation of the deformable mirror. It will detect if a sequence was taken in "waffle mode" (e.g., most of the science sequence consisting of center frames), which allows for tracking the astrometry and photometry of the star throughout the sequence. Depending on this flag, the post-processing will be adjusted accordingly.

All observations sequences will be shown, even if the data is not yet public as file headers become public immediately. If you wish to reduce proprietary data you can provide your ESO credentials in the reduction script. Public data can be reduced without login.


Documentation
-------------
Currently the documentation is focused on usage examples. More documentation will follow. The current examples are:

- generate_database.py: Script to generate the observation database from scratch. However, the repository comes with tables that have been generated recently, as such this would only be necessary if very new data is reduced. It is complete at least up to April 2024.
- explore_database.ipynb: Jupyter notebook that demonstrates how to search and filter the database for SPHERE observations that are of interest to you. A similar filtering for specific observation sequences can be done in the ``ifs_reduction_template.py``, to automatically reduce all selected observations.
- ifs_reduction_template.py: Demonstrated how to run the complete workflow outlined above for IFS data, everything from data download to post-processing.

The pipeline requires the ``table_of_IFS_observations`` and ``table_of_files`` to run. These files are contained in the repository. The ``table_of_IFS_observations`` contains all individual observing sequences done with SPHERE and information on the respective target star. The ``table_of_files`` contains the names of all SPHERE fits files and important header information.  


TL;DR setup guide
-----------------
.. code-block:: bash

    pip install git+https://github.com/m-samland/spherical.git

Download the ``table_of_IFS_observations`` and ``table_of_files`` in a directory of your choice, then launch the ``explore_database.ipynb`` notebook to explore all SPHERE/IFS data taken.
If you want to generate the database from scratch or update an existing one, use the ``generate_database.py`` script.
The script ``ifs_reduction_template.py`` in the examples folder can be used to reduce any SPHERE IFS observation: automatically performing everything from data download, spectral cube extraction and calibration, TRAP pipeline post-processing, automatic detection of point sources and extraction of spectra of probable candidates.

Installation and dependencies
-----------------------------
The benefits of using a Python package manager (distribution), such as
(ana)conda, are many. Mainly, it brings easy and robust package
management and avoids messing up with your system's default python. 
We recommend using
`Miniconda <https://conda.io/miniconda>`_.

Before installing the package, it is **highly recommended to create a dedicated
conda environment** to not mess up with the package versions in your base
environment. This can be done easily with (replace ``spherical_env`` by the name you want
for your environment):

.. code-block:: bash

  conda create -n spherical_env python=3.11

Then, to activate it (assuming you named it as above):

.. code-block:: bash

  conda activate spherical_env


The pipeline depends on several packages: ``charis-dep`` for extracting the calibrated spectral cubes from raw IFS data,
and ``trap`` and ``species`` for automated post-processing, planet detection and extraction of the
candidates' spectra. These packages all come with their own set of dependencies from the Python ecosystem, such as
``numpy``, ``scipy``, ``matplotlib``, ``pandas``, ``astropy``, ``scikit-learn``, ``scikit-image``, ``photutils`` and others.
``astroquery`` is used for querying the ESO archive and various catalogs.

There are 2 ways to get it all installed at once.

1. The most convenient way is simply to run, once in the environment:

.. code-block:: bash

  pip install git+https://github.com/m-samland/spherical.git

If later on, you want to upgrade to the latest spherical version, it would be a matter of:

.. code-block:: bash

  pip install git+https://github.com/m-samland/spherical.git --upgrade

2. Alternatively, if you also want the example notebooks, clone the repository first and pip install locally:

.. code-block:: bash

  # cd where you want your local repository to be located
  git clone git+https://github.com/m-samland/spherical.git
  # cd in your local repository
  pip install -e .

In the latter case, you can benefit from the latest changes made to the repository any time, with:

.. code-block:: bash

  git pull


Publications that made use of spherical:
-------------------------------------------------

- `Franson et al. (2023) <https://ui.adsabs.harvard.edu/abs/2023AJ....165...39F/abstract>`_


Attribution
-----------

..
  If the spherical package is useful to your science, we kindly ask you to cite:

..
  Add citation link here

As well as the following publication, if you used the IFS pipeline and/or TRAP post-processing:

- `Samland et al. (2022) <https://ui.adsabs.harvard.edu/abs/2022A%26A...668A..84S/abstract>`_ for the new SPHERE-IFS pipeline;
- `Samland et al. (2021) <https://ui.adsabs.harvard.edu/abs/2017AJ....154....7G/abstract>`_ for TRAP detection and characterization of exoplanets;

The TRAP IFS reduction makes further use of the stellar and exoplanet spectral tools in the ``species`` package, for spectral template matching and absolute photometric calibration of the candidate spectra. If this functionality was used, please kindly cite:

- `Stolker et al. (2020) <https://ui.adsabs.harvard.edu/abs/2020A%26A...635A.182S/abstract>`_


Contributing
------------

Please open a new issue or new pull request for bugs, feedback, or new features you would like to see.  If there is an issue you would like to work on, please leave a comment and we will be happy to assist.   New contributions and contributors are very welcome!

New to github or open source projects?  If you are unsure about where to start or haven't used github before, please feel free to email `@m-samland`_.

Feedback and feature requests?  Is there something missing you would like to see?  Please open an issue or send an email to  `@m-samland`_.